<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque Din√¢mico MVC</title>
    <link rel="stylesheet" href="/public/styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
</head>
<body>

    <div class="container mt-5">
        <h1 class="mb-4">üìã Controle de Estoque de Produtos</h1>
        <!--bot√£o adicionar produto-->
        <button class="btn" onclick="openModal('addProdutoModal')">‚ûï Adicionar Novo Produto</button>
        <!--bot√£o adicionar produto-->
        
        <hr>

        <h2>Estoque Atual</h2>
        <table class="table table-striped" id="estoqueTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Produto</th>
                    <th>Unidade</th>
                    <th>Estoque</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                <% produtos.forEach(produto => { %>
                    <tr id="row-<%= produto.id_produto %>">
                        <td><%= produto.id_produto %></td>
                        <td><%= produto.nome_produto %></td>
                        <td><%= produto.tipo_unidade %></td>
                        <td id="quant-<%= produto.id_produto %>"><%= produto.quant_estoque %></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="openEditModal(<%= produto.id_produto %>, '<%= produto.nome_produto %>', <%= produto.quant_estoque %>)">
                                ‚úèÔ∏è Movimentar
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="excluirProduto(<%= produto.id_produto %>, '<%= produto.nome_produto %>')">
                                üóëÔ∏è Excluir
                            </button>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>

    <div id="addProdutoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('addProdutoModal')">&times;</span>
            <h3>Adicionar Produto e Entrada Inicial</h3>
            <form id="addProdutoForm">
                <div class="mb-3">
                    <label for="nome" class="form-label">Nome do Produto:</label>
                    <input type="text" class="form-control" id="nome" name="nome" required>
                </div>
                <div class="mb-3">
                    <label for="unidade" class="form-label">Tipo de Unidade (ex: Quilo, Garrafa):</label>
                    <input type="text" class="form-control" id="unidade" name="unidade" required>
                </div>
                <div class="mb-3">
                    <label for="quantidade" class="form-label">Quantidade Inicial de Entrada:</label>
                    <input type="number" class="form-control" id="quantidade" name="quantidade" min="1" required>
                </div>
                <button type="submit" class="btn btn-success">‚úÖ Salvar Produto</button>
            </form>
        </div>
    </div>

    <div id="editProdutoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('editProdutoModal')">&times;</span>
            <h3 id="editModalTitle">Movimentar Estoque</h3>
            <p>Estoque atual: <strong id="estoqueAtualDisplay"></strong></p>
            <form id="editProdutoForm">
                <input type="hidden" id="edit_id_produto" name="id_produto">
                
                <div class="mb-3">
                    <label for="edit_quantidade" class="form-label">Quantidade a Movimentar:</label>
                    <input type="number" class="form-control" id="edit_quantidade" name="quantidade" min="1" required>
                </div>
                
                <div class="mb-3">
                    <label for="tipo_movimentacao" class="form-label">Tipo de Movimenta√ß√£o:</label>
                    <select class="form-select" id="tipo_movimentacao" name="tipo_movimentacao" required>
                        <option value="entrada">Entrada (Adicionar)</option>
                        <option value="saida">Sa√≠da (Remover)</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-warning">üîÑ Registrar Movimenta√ß√£o</button>
            </form>
        </div>
    </div>


    <script>
        // --- FUN√á√ïES DE MODAL ---

        /** Abre um modal espec√≠fico */
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        /** Fecha um modal espec√≠fico */
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        /** * Prepara e abre o modal de edi√ß√£o/movimenta√ß√£o.
         * @param {number} id - ID do produto.
         * @param {string} nome - Nome do produto.
         * @param {number} estoque - Estoque atual do produto.
         */
        function openEditModal(id, nome, estoque) {
            document.getElementById('editModalTitle').innerText = `Movimentar: ${nome}`;
            document.getElementById('edit_id_produto').value = id;
            document.getElementById('estoqueAtualDisplay').innerText = estoque;
            document.getElementById('edit_quantidade').value = 1; // Reseta o campo
            openModal('editProdutoModal');
        }

        // --- FUN√á√ïES DE INTERA√á√ÉO COM O BACKEND (AJAX/Fetch) ---

        /** * Atualiza a quantidade exibida na tabela para um produto espec√≠fico.
         * @param {number} id - ID do produto.
         */
        async function atualizarEstoqueProduto(id) {
            try {
                // Endpoint para recalcular o estoque de todos e buscar o valor novo
                const response = await fetch('/', { 
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json' // Opcional, para simular a requisi√ß√£o e pegar o valor atualizado
                    } 
                });
                
                // Melhor seria criar uma rota /api/estoque/id para evitar renderizar a p√°gina toda
                // Por simplicidade, vamos usar o valor retornado pela movimenta√ß√£o (que √© a forma mais r√°pida de atualizar a View)
                // Ou, se a lista for pequena, recalcular todos e atualizar.

                // Como a rota '/' retorna HTML, vamos fazer uma busca mais simples no DOM 
                // e recalcular o valor no frontend (menos ideal, mas mais simples) 
                
                // Uma solu√ß√£o MVC/API ideal:
                // 1. Criar uma rota: GET /api/estoque
                // 2. Chamar: const response = await fetch('/api/estoque');
                // 3. Re-renderizar o <tbody> inteiro.

                // Solu√ß√£o Simplificada (Requisito: atualizar dinamicamente):
                // Vamos refazer a requisi√ß√£o GET para a p√°gina e substituir apenas o corpo da tabela.
                // Isso garante que o estoque esteja sempre correto (calculado no DB).
                const fullResponse = await fetch('/');
                const htmlText = await fullResponse.text();

                // Cria um elemento tempor√°rio para parsear o HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlText;
                
                // Encontra a nova tabela e pega o novo tbody
                const newTbody = tempDiv.querySelector('#estoqueTable tbody');
                
                // Substitui o tbody atual pelo novo tbody
                const currentTbody = document.getElementById('estoqueTable').querySelector('tbody');
                currentTbody.parentNode.replaceChild(newTbody, currentTbody);

            } catch (error) {
                console.error('Erro ao buscar estoque atualizado:', error);
                alert('Erro ao atualizar a lista de estoque. Recarregue a p√°gina.');
            }
        }

        /**
         * Lida com o envio do formul√°rio de Adi√ß√£o de Produto.
         */
        document.getElementById('addProdutoForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // Impede o recarregamento da p√°gina
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/produtos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('üéâ Produto adicionado com sucesso!');
                    closeModal('addProdutoModal');
                    // Atualiza a tabela dinamicamente
                    await atualizarEstoqueProduto(result.id); 
                } else {
                    alert('‚ùå Erro: ' + result.message);
                }
            } catch (error) {
                console.error('Erro de rede/servidor:', error);
                alert('Erro ao comunicar com o servidor.');
            }
        });

        /**
         * Lida com o envio do formul√°rio de Movimenta√ß√£o de Estoque.
         */
        document.getElementById('editProdutoForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/movimentacoes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('üì¶ Movimenta√ß√£o registrada!');
                    closeModal('editProdutoModal');
                    // Atualiza a tabela dinamicamente
                    await atualizarEstoqueProduto(data.id_produto); 
                } else {
                    alert('‚ùå Erro: ' + result.message);
                }
            } catch (error) {
                console.error('Erro de rede/servidor:', error);
                alert('Erro ao comunicar com o servidor.');
            }
        });


        /**
         * Lida com a exclus√£o de um produto.
         * @param {number} id - ID do produto.
         * @param {string} nome - Nome do produto (para confirma√ß√£o).
         */
        async function excluirProduto(id, nome) {
            if (!confirm(`Tem certeza que deseja EXCLUIR o produto "${nome}" (ID: ${id}) e todas as suas movimenta√ß√µes?`)) {
                return; // Aborta se o usu√°rio cancelar
            }

            try {
                // Requisi√ß√£o DELETE para a rota de exclus√£o
                const response = await fetch(`/produtos/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(`üóëÔ∏è Produto exclu√≠do: ${nome}`);
                    // Remove a linha da tabela dinamicamente
                    const rowToRemove = document.getElementById(`row-${id}`);
                    if (rowToRemove) {
                        rowToRemove.remove();
                    }
                } else {
                    alert('‚ùå Erro: ' + result.message);
                }
            } catch (error) {
                console.error('Erro ao excluir produto:', error);
                alert('Erro ao tentar excluir o produto.');
            }
        }
    </script>
</body>
</html>